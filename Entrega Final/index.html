<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Pizzería La Fornace</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/png" href="image/pizzeria_la_fornace_png.png">
  </head>
  <body class="bg-cream">
    <nav class="navbar navbar-expand-lg navbar-dark bg-fornace sticky-top shadow-sm">
      <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="index.html">
          <img src="image/pizzeria_la_fornace_png.png" alt="La Fornace" width="56" height="56" class="me-2">
          <span>La Fornace</span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav" aria-controls="mainNav" aria-expanded="false" aria-label="Alternar navegación">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="mainNav">
          <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
            <li class="nav-item"><a class="nav-link active" href="#menu">Menú</a></li>
            <li class="nav-item"><a class="nav-link" href="tu-cuenta/index.html">Tu Cuenta</a></li>
            <li class="nav-item"><a class="nav-link" href="tu-cuenta/pedidos.html">Tus Pedidos</a></li>
            <li class="nav-item">
              <a class="btn btn-sm btn-primary ms-lg-3" href="carrito/index.html">
                Carrito <span class="badge text-bg-light ms-1" id="carrito-badge">0</span>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <main>
      <section class="container py-3">
        <div id="heroCarousel" class="carousel slide" data-bs-ride="carousel">
          <div class="carousel-indicators">
            <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
            <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="1" aria-label="Slide 2"></button>
          </div>
          <div class="carousel-inner rounded-3 overflow-hidden shadow-sm">
            <div class="carousel-item">
              <img src="image/ChatGPT Image 25 sept 2025, 21_20_51.png" class="d-block w-100" alt="Promoción La Fornace">
              <div class="carousel-caption d-none d-md-block">
                <h5>Combos para compartir</h5>
                <p>Elige tu bebida favorita.</p>
              </div>
            </div>
            <div class="carousel-item active">
              <img src="image/ChatGPT Image 25 sept 2025, 21_18_38.png" class="d-block w-100" alt="Pizza tradicional">
              <div class="carousel-caption d-none d-md-block">
                <h5>Auténtica pizza al horno</h5>
                <p>Recetas clásicas e ingredientes frescos.</p>
              </div>
            </div>
          </div>
          <button class="carousel-control-prev" type="button" data-bs-target="#heroCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Anterior</span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#heroCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Siguiente</span>
          </button>
        </div>
      </section>

      <section class="container my-4" id="menu">
        <div class="row g-4">
          <aside class="col-12 col-lg-2"></aside>

          <div class="col-12 col-lg-8">
            <h2 class="mb-4 text-center">Nuestro Menú</h2>
            
            <!-- Contenedor de mensajes -->
            <div id="mensaje-container"></div>
            
            <!-- Contenedor del Menú -->
            <div id="menu-container">
              <!-- Las categorías y productos se cargarán aquí con JavaScript -->
            </div>
          </div>

          <aside class="col-12 col-lg-2"></aside>
        </div>
      </section>
    </main>

    <footer class="bg-dark text-white py-4 mt-5">
      <div class="container text-center small">
        <img src="image/pizzeria_la_fornace_png.png" alt="La Fornace" width="40" class="mb-2">
        <div>Pizzería La Fornace · Solo entregamos calidad</div>
        <div>© 2025 La Fornace · Todos los derechos reservados</div>
      </div>
    </footer>

    <!-- Modal para seleccionar tamaño y extras de pizza -->
    <div class="modal fade" id="modalTamanio" tabindex="-1" aria-labelledby="modalTamanioLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-fornace text-white">
            <h5 class="modal-title" id="modalTamanioLabel">Personaliza tu pizza</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <div class="text-center mb-4">
              <img id="modal-pizza-imagen" src="" alt="" class="img-fluid rounded" style="max-height: 150px;">
              <h4 id="modal-pizza-nombre" class="mt-3"></h4>
              <p id="modal-pizza-descripcion" class="text-muted"></p>
            </div>
            
            <!-- Selección de tamaño -->
            <div class="mb-4">
              <h6 class="fw-bold mb-3">Tamaño</h6>
              <div class="list-group" id="modal-tamanios">
                <!-- Se llenarán dinámicamente -->
              </div>
            </div>
            
            <!-- Selección de extras -->
            <div class="mb-4">
              <h6 class="fw-bold mb-3">Extras (Opcional)</h6>
              <div class="row" id="modal-extras">
                <!-- Se llenarán dinámicamente -->
              </div>
            </div>
            
            <!-- Resumen de precio -->
            <div class="alert alert-light border" id="modal-precio-resumen">
              <div class="d-flex justify-content-between align-items-center">
                <span class="fw-bold">Total:</span>
                <span class="fs-5 text-primary fw-bold" id="modal-precio-total">$0</span>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary" id="btn-agregar-carrito" onclick="agregarPizzaAlCarrito()">
              Agregar al Carrito
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script src="js/api.js"></script>
    <script src="scripts.js"></script>
    <script src="data/mock-data.js"></script>
    
    <script>
      // ========================================
      // VARIABLES GLOBALES
      // ========================================
      let pizzaSeleccionada = null;
      let tamanioSeleccionado = null;
      let extrasSeleccionados = [];
      let tamaniosDisponibles = [];
      let extrasDisponibles = [];
      let productosDisponibles = []; // Flat list for easy access
      const modalTamanio = new bootstrap.Modal(document.getElementById('modalTamanio'));

      // ========================================
      // RENDERIZAR PIZZAS EN EL MENÚ
      // ========================================
      async function renderizarPizzas() {
        const container = document.getElementById('menu-container');
        container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div></div>';
        
        try {
            const menuData = await api.get('/productos/menu/completo');
            
            container.innerHTML = '';
            
            if (!menuData || !menuData.categorias_con_productos || menuData.categorias_con_productos.length === 0) {
              container.innerHTML = `
                <div class="d-flex justify-content-center align-items-center py-5" style="min-height: 300px;">
                  <div class="text-center text-muted">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-shop mb-3" viewBox="0 0 16 16">
                      <path d="M2.97 1.35A1 1 0 0 1 3.73 1h8.54a1 1 0 0 1 .76.35l2.609 3.044A1.5 1.5 0 0 1 16 5.37v.255a2.375 2.375 0 0 1-4.25 1.458A2.371 2.371 0 0 1 9.875 8 2.37 2.37 0 0 1 8 7.083 2.37 2.37 0 0 1 6.125 8a2.37 2.37 0 0 1-1.875-.917A2.375 2.375 0 0 1 0 5.625V5.37a1.5 1.5 0 0 1 .361-.976l2.61-3.045zm1.78 4.275a1.375 1.375 0 0 0 2.75 0 .5.5 0 0 1 1 0 1.375 1.375 0 0 0 2.75 0 .5.5 0 0 1 1 0 1.375 1.375 0 1 0 2.75 0V5.37a.5.5 0 0 0-.12-.325L12.27 2H3.73L1.12 5.045A.5.5 0 0 0 1 5.37v.255a1.375 1.375 0 0 0 2.75 0 .5.5 0 0 1 1 0zM1.5 8.5A.5.5 0 0 1 2 9v6h1v-5a1 1 0 0 1 1-1h3a1 1 0 0 1 1 1v5h6V9a.5.5 0 0 1 1 0v6h.5a.5.5 0 0 1 0 1H.5a.5.5 0 0 1 0-1H1V9a.5.5 0 0 1 .5-.5zM4 15h3v-5H4v5zm5-5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1v-3z"/>
                    </svg>
                    <h4>No hay productos disponibles en este momento</h4>
                    <p>Estamos preparando nuestro delicioso menú. ¡Vuelve pronto!</p>
                  </div>
                </div>
              `;
              return;
            }
            
            // Guardar datos globales
            tamaniosDisponibles = menuData.tamanios || [];
            extrasDisponibles = menuData.extras || [];
            
            // Aplanar lista de productos para búsqueda fácil
            productosDisponibles = [];
            menuData.categorias_con_productos.forEach(cat => {
                if (cat.productos) {
                    productosDisponibles = [...productosDisponibles, ...cat.productos];
                }
            });

            // Ordenar categorías: Pizzas primero
            menuData.categorias_con_productos.sort((a, b) => {
                const nombreA = a.categoria.nombre.toLowerCase();
                const nombreB = b.categoria.nombre.toLowerCase();
                
                // Pizzas primero
                if (nombreA.includes('pizza') && !nombreB.includes('pizza')) return -1;
                if (!nombreA.includes('pizza') && nombreB.includes('pizza')) return 1;
                
                return nombreA.localeCompare(nombreB);
            });
            
            // Renderizar por categorías
            menuData.categorias_con_productos.forEach(categoriaGroup => {
                const categoria = categoriaGroup.categoria;
                const productos = categoriaGroup.productos;
                
                if (productos.length === 0) return;

                // Crear sección de categoría
                const section = document.createElement('div');
                section.className = 'mb-5';
                
                // Título de categoría
                const title = document.createElement('h3');
                title.className = 'border-bottom pb-2 mb-4 text-fornace fw-bold';
                title.textContent = categoria.nombre;
                section.appendChild(title);
                
                // Grid de productos
                const grid = document.createElement('div');
                grid.className = 'row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4';
                
                productos.forEach(pizza => {
                  const col = document.createElement('div');
                  col.className = 'col';
                  
                  // Calcular precio base
                  const precioMostrar = pizza.precio; 
                  
                  col.innerHTML = `
                    <div class="card h-100 shadow-sm product-card">
                      <div class="position-relative">
                        <img src="${pizza.image_url || 'image/placeholder.jpg'}" class="card-img-top" alt="${pizza.nombre}" style="height: 200px; object-fit: cover;">
                        ${!pizza.disponible ? '<span class="position-absolute top-0 end-0 badge bg-danger m-2">Agotado</span>' : ''}
                      </div>
                      <div class="card-body d-flex flex-column">
                        <h5 class="card-title fw-bold">${pizza.nombre}</h5>
                        <p class="card-text small text-muted flex-grow-1">${pizza.descripcion || ''}</p>
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <span class="fs-5 fw-bold text-primary">${formatearPrecio(precioMostrar)}</span>
                        </div>
                      </div>
                      <div class="card-footer bg-white border-top-0 pb-3">
                        <button class="btn btn-primary w-100" onclick="abrirModalTamanio(${pizza.id})" ${!pizza.disponible ? 'disabled' : ''}>
                          ${!pizza.disponible ? 'No disponible' : 'Agregar al carrito'}
                        </button>
                      </div>
                    </div>
                  `;
                  
                  grid.appendChild(col);
                });
                
                section.appendChild(grid);
                container.appendChild(section);
            });
            
        } catch (error) {
            console.error(error);
            container.innerHTML = '<div class="alert alert-danger text-center">Error al cargar el menú. Por favor intenta más tarde.</div>';
        }
      }

      // ========================================
      // VERIFICAR SI EL PRODUCTO REQUIERE TAMAÑO
      // ========================================
      function productoRequiereTamanio(producto) {
        // Los líquidos/bebestibles no requieren tamaño
        if (!producto || !producto.categoria) return true; // Por defecto, sí requiere
        
        const categoriaNombre = producto.categoria.nombre.toLowerCase();
        const categoriasNoTamanio = ['líquidos', 'liquidos', 'bebestibles', 'bebidas', 'jugos', 'gaseosas'];
        
        return !categoriasNoTamanio.some(cat => categoriaNombre.includes(cat));
      }

      // ========================================
      // ABRIR MODAL PARA SELECCIONAR TAMAÑO Y EXTRAS
      // ========================================
      function abrirModalTamanio(pizzaId) {
        // Buscar en la lista cargada desde API
        // Nota: Usamos la variable global productosDisponibles directamente
        pizzaSeleccionada = productosDisponibles.find(p => p.id === pizzaId);
        
        if (!pizzaSeleccionada) {
            console.error("Producto no encontrado:", pizzaId);
            return;
        }

        tamanioSeleccionado = null;
        extrasSeleccionados = [];
        
        // Actualizar información del modal
        const img = document.getElementById('modal-pizza-imagen');
        img.src = pizzaSeleccionada.image_url || 'image/placeholder.jpg';
        img.alt = pizzaSeleccionada.nombre;
        
        document.getElementById('modal-pizza-nombre').textContent = pizzaSeleccionada.nombre;
        document.getElementById('modal-pizza-descripcion').textContent = pizzaSeleccionada.descripcion || '';
        
        // Verificar si el producto requiere tamaño
        const requiereTamanio = productoRequiereTamanio(pizzaSeleccionada);
        
        // Renderizar opciones de tamaño (o ocultar si no aplica)
        renderizarOpcionesTamanio(requiereTamanio);
        
        // Renderizar extras disponibles
        renderizarExtras();
        
        // Actualizar precio total
        actualizarPrecioTotal();
        
        // Habilitar/deshabilitar botón según si requiere tamaño
        if (requiereTamanio) {
            document.getElementById('btn-agregar-carrito').disabled = true;
        } else {
            // Para productos sin tamaño, habilitar directamente
            document.getElementById('btn-agregar-carrito').disabled = false;
        }
        
        modalTamanio.show();
      }
      
      // ========================================
      // RENDERIZAR OPCIONES DE TAMAÑO
      // ========================================
      function renderizarOpcionesTamanio(requiereTamanio = true) {
        const tamaniosContainer = document.getElementById('modal-tamanios');
        const tamaniosSection = tamaniosContainer.closest('.mb-4');
        
        // Si el producto no requiere tamaño (ej: líquidos), ocultar la sección
        if (!requiereTamanio) {
            if (tamaniosSection) tamaniosSection.style.display = 'none';
            tamaniosContainer.innerHTML = '';
            return;
        }
        
        // Mostrar sección de tamaños
        if (tamaniosSection) tamaniosSection.style.display = 'block';
        
        tamaniosContainer.innerHTML = '';
        
        if (!tamaniosDisponibles || tamaniosDisponibles.length === 0) {
             tamaniosContainer.innerHTML = '<div class="alert alert-warning">No hay tamaños disponibles</div>';
             return;
        }

        tamaniosDisponibles.forEach(tamanio => {
          // Asegurar que los precios sean números
          const precioBase = parseFloat(pizzaSeleccionada.precio) || 0;
          const precioAdicional = parseFloat(tamanio.precio_adicional) || 0;
          const precioTotal = precioBase + precioAdicional;
          
          const item = document.createElement('button');
          item.type = 'button';
          item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
          item.onclick = (e) => seleccionarTamanio(tamanio, precioTotal, e);
          
          item.innerHTML = `
            <div>
              <strong class="text-capitalize">${tamanio.nombre}</strong>
              <br>
              <small class="text-muted">Pizza ${tamanio.nombre}</small>
            </div>
            <span class="badge bg-primary rounded-pill fs-6">${formatearPrecio(precioTotal)}</span>
          `;
          
          tamaniosContainer.appendChild(item);
        });
      }
      
      // ========================================
      // RENDERIZAR EXTRAS DISPONIBLES
      // ========================================
      function renderizarExtras() {
        const extrasContainer = document.getElementById('modal-extras');
        
        if (!extrasDisponibles || extrasDisponibles.length === 0) {
          extrasContainer.innerHTML = '<div class="col-12 text-muted">No hay extras disponibles</div>';
          return;
        }
        
        // Filtrar extras que estén vinculados a este producto
        // Si productos_ids está vacío o no existe, el extra aplica a todos
        const extrasParaProducto = extrasDisponibles.filter(extra => {
          // Si no tiene productos_ids o está vacío, aplica a todos los productos
          if (!extra.productos_ids || extra.productos_ids.length === 0) {
            return true;
          }
          // Si tiene productos_ids, verificar si el producto actual está incluido
          return extra.productos_ids.includes(pizzaSeleccionada.id);
        });
        
        if (extrasParaProducto.length === 0) {
          extrasContainer.innerHTML = '<div class="col-12 text-muted">No hay extras disponibles para este producto</div>';
          return;
        }
        
        extrasContainer.innerHTML = '';
        
        extrasParaProducto.forEach(extra => {
          const col = document.createElement('div');
          col.className = 'col-md-6 mb-3';
          
          // Asegurar que el precio sea un número
          const precioExtra = parseFloat(extra.precio) || 0;
          
          col.innerHTML = `
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="${extra.id}" id="extra-${extra.id}" 
                     onchange="toggleExtra(${extra.id})">
              <label class="form-check-label w-100" for="extra-${extra.id}">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <strong>${extra.nombre}</strong>
                    <br>
                    <small class="text-muted">Extra</small>
                  </div>
                  <span class="badge bg-success">+${formatearPrecio(precioExtra)}</span>
                </div>
              </label>
            </div>
          `;
          
          extrasContainer.appendChild(col);
        });
      }
      
      // ========================================
      // SELECCIONAR TAMAÑO
      // ========================================
      function seleccionarTamanio(tamanio, precioTotal, event) {
        tamanioSeleccionado = tamanio;
        
        // Actualizar UI de tamaños
        document.querySelectorAll('#modal-tamanios button').forEach(btn => {
          btn.classList.remove('active');
        });
        // Find the button that was clicked (event.target might be a child)
        const button = event.target.closest('button');
        if(button) button.classList.add('active');
        
        // Habilitar botón de agregar al carrito
        document.getElementById('btn-agregar-carrito').disabled = false;
        
        // Actualizar precio total
        actualizarPrecioTotal();
      }
      
      // ========================================
      // TOGGLE EXTRA
      // ========================================
      function toggleExtra(extraId) {
        const checkbox = document.getElementById(`extra-${extraId}`);
        const extra = extrasDisponibles.find(e => e.id === extraId);
        
        if (!extra) return;

        if (checkbox.checked) {
          if (!extrasSeleccionados.find(e => e.id === extraId)) {
            extrasSeleccionados.push(extra);
          }
        } else {
          extrasSeleccionados = extrasSeleccionados.filter(e => e.id !== extraId);
        }
        
        // Actualizar precio total
        actualizarPrecioTotal();
      }
      
      // ========================================
      // ACTUALIZAR PRECIO TOTAL
      // ========================================
      function actualizarPrecioTotal() {
        let total = 0;
        const precioBase = parseFloat(pizzaSeleccionada.precio) || 0;
        
        // Si requiere tamaño y hay uno seleccionado, sumar precio adicional
        if (productoRequiereTamanio(pizzaSeleccionada)) {
          if (tamanioSeleccionado) {
            const precioAdicional = parseFloat(tamanioSeleccionado.precio_adicional) || 0;
            total = precioBase + precioAdicional;
          }
          // Si no hay tamaño seleccionado, mostrar 0 (no puede agregar)
        } else {
          // Producto sin tamaño (ej: líquidos), usar solo precio base
          total = precioBase;
        }
        
        // Sumar extras
        extrasSeleccionados.forEach(extra => {
          const precioExtra = parseFloat(extra.precio) || 0;
          total += precioExtra;
        });
        
        document.getElementById('modal-precio-total').textContent = formatearPrecio(total);
      }

      // ========================================
      // AGREGAR PIZZA AL CARRITO
      // ========================================
      function agregarPizzaAlCarrito() {
        const requiereTamanio = productoRequiereTamanio(pizzaSeleccionada);
        
        // Validar tamaño solo si es requerido
        if (requiereTamanio && !tamanioSeleccionado) {
          mostrarError('Por favor selecciona un tamaño');
          return;
        }
        
        // Construir objeto item para el carrito
        // Asegurar que los precios sean números
        const precioProducto = parseFloat(pizzaSeleccionada.precio) || 0;
        const precioTamanio = requiereTamanio && tamanioSeleccionado ? parseFloat(tamanioSeleccionado.precio_adicional) || 0 : 0;
        const precioBase = precioProducto + precioTamanio;
        
        const precioExtras = extrasSeleccionados.reduce((sum, e) => {
          return sum + (parseFloat(e.precio) || 0);
        }, 0);
        
        const precioTotal = precioBase + precioExtras;

        const item = {
            id: Date.now(), // ID temporal para el frontend
            productoId: pizzaSeleccionada.id,
            nombre: pizzaSeleccionada.nombre,
            descripcion: pizzaSeleccionada.descripcion,
            imagen: pizzaSeleccionada.image_url || 'image/placeholder.jpg',
            
            tamanioId: tamanioSeleccionado ? tamanioSeleccionado.id : null,
            tamanioNombre: tamanioSeleccionado ? tamanioSeleccionado.nombre : 'Único',
            
            extras: extrasSeleccionados.map(e => ({
                id: e.id,
                nombre: e.nombre,
                precio: parseFloat(e.precio) || 0
            })),
            
            precioBase: precioBase,
            precioUnitario: precioTotal,
            cantidad: 1,
            
            // Datos para sincronización con API
            apiData: {
                producto_id: pizzaSeleccionada.id,
                tamanio_id: tamanioSeleccionado ? tamanioSeleccionado.id : null,
                extras_ids: extrasSeleccionados.map(e => e.id),
                cantidad: 1
            }
        };
        
        // Usar localStorage directamente para simplificar, o llamar a una función auxiliar si existiera
        let carrito = cargarCarrito();
        carrito.push(item);
        guardarCarrito(carrito);
        
        modalTamanio.hide();
        actualizarBadgeCarrito();
        
        // Crear mensaje descriptivo
        let mensaje = tamanioSeleccionado 
            ? `${pizzaSeleccionada.nombre} (${tamanioSeleccionado.nombre})`
            : pizzaSeleccionada.nombre;
        if (extrasSeleccionados.length > 0) {
          const nombresExtras = extrasSeleccionados.map(e => e.nombre).join(', ');
          mensaje += ` con extras: ${nombresExtras}`;
        }
        mensaje += ' agregado al carrito';
        
        mostrarExito(mensaje);
        
        // Scroll suave al mensaje
        setTimeout(() => {
          const msgContainer = document.getElementById('mensaje-container');
          if(msgContainer) msgContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
      }

      // ========================================
      // INICIALIZACIÓN
      // ========================================
      document.addEventListener('DOMContentLoaded', function() {
        // Renderizar pizzas
        renderizarPizzas();
        
        // Actualizar badge del carrito
        actualizarBadgeCarrito();
      });
    </script>
  </body>
</html>


