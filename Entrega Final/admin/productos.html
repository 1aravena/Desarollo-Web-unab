<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gestión de Productos - La Fornace Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="../styles.css">
    <link rel="icon" type="image/png" href="../image/pizzeria_la_fornace_png.png">
</head>
<body class="bg-cream">
    <!-- Historia: B-06 CRUD de Productos -->
    
    <nav class="navbar navbar-expand-lg navbar-dark bg-fornace sticky-top shadow-sm">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="index.html">
                <img src="../image/pizzeria_la_fornace_png.png" alt="La Fornace" width="56" height="56" class="me-2">
                <span>La Fornace Admin</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="mainNav">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="index.html">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link active" href="productos.html">Productos</a></li>
                    <li class="nav-item"><a class="nav-link" href="cocina.html">Cocina</a></li>
                    <li class="nav-item"><a class="nav-link" href="reportes.html">Reportes</a></li>
                    <li class="nav-item"><a class="nav-link" href="ranking.html">Ranking</a></li>
                    <li class="nav-item"><a class="nav-link" href="notificaciones.html">Notificaciones</a></li>
                    <li class="nav-item"><a class="nav-link" href="../index.html">Volver a la Tienda</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container py-5">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Gestión de Productos</h2>
                    <div>
                        <button class="btn btn-info me-2 text-white" onclick="abrirModalExtra()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-lg me-1" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z"/>
                            </svg>
                            Agregar Extra
                        </button>
                        <button class="btn btn-success" onclick="abrirModalProducto()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-lg me-1" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z"/>
                            </svg>
                            Agregar Producto
                        </button>
                    </div>
                </div>

                <div id="mensaje-container"></div>

                <!-- Tabla de Productos -->
                <div class="card shadow-sm border-0 mb-5">
                    <div class="card-header bg-white border-0 pt-4 px-4">
                        <h4 class="mb-0">Listado de Productos</h4>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 30%">Producto</th>
                                        <th style="width: 15%">Categoría</th>
                                        <th style="width: 15%">Precio Base</th>
                                        <th style="width: 10%">Stock</th>
                                        <th style="width: 10%" class="text-center">Estado</th>
                                        <th style="width: 20%" class="text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="productos-tbody">
                                    <!-- Se llena dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Tabla de Tamaños -->
                <div class="card shadow-sm border-0 mb-5">
                    <div class="card-header bg-white border-0 pt-4 px-4 d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">Tamaños de Pizza</h4>
                        <button class="btn btn-warning btn-sm" onclick="abrirModalTamanio()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-lg me-1" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z"/>
                            </svg>
                            Agregar Tamaño
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 35%">Nombre</th>
                                        <th style="width: 25%">Precio Adicional</th>
                                        <th style="width: 15%" class="text-center">Estado</th>
                                        <th style="width: 25%" class="text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tamanios-tbody">
                                    <!-- Se llena dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer bg-light">
                        <small class="text-muted">
                            <strong>Nota:</strong> El precio adicional se suma al precio base del producto. Por ejemplo, si una pizza tiene precio base $8.000 y el tamaño "Familiar" tiene precio adicional de $4.000, el precio final será $12.000.
                        </small>
                    </div>
                </div>

                <!-- Tabla de Extras -->
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white border-0 pt-4 px-4">
                        <h4 class="mb-0">Listado de Extras</h4>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 40%">Extra</th>
                                        <th style="width: 20%">Precio</th>
                                        <th style="width: 20%" class="text-center">Estado</th>
                                        <th style="width: 20%" class="text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="extras-tbody">
                                    <!-- Se llena dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Producto -->
    <div class="modal fade" id="modalProducto" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-fornace text-white">
                    <h5 class="modal-title" id="modalProductoLabel">Agregar Producto</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-producto" onsubmit="return guardarProducto(event)">
                    <div class="modal-body">
                        <input type="hidden" id="producto-id">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="producto-nombre" class="form-label">Nombre del Producto *</label>
                                <input type="text" class="form-control" id="producto-nombre" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="producto-categoria" class="form-label">Categoría *</label>
                                <select class="form-select" id="producto-categoria" required>
                                    <option value="">Seleccione...</option>
                                    <!-- Se llena dinámicamente -->
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="producto-descripcion" class="form-label">Descripción</label>
                            <textarea class="form-control" id="producto-descripcion" rows="2"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="producto-precio" class="form-label">Precio (CLP) *</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="producto-precio" min="0" step="100" placeholder="Ej: 10000" required>
                                </div>
                                <div class="form-text">Ingrese el valor en pesos chilenos</div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="producto-stock" class="form-label">Stock *</label>
                                <input type="number" class="form-control" id="producto-stock" min="0" value="100" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="producto-estado" class="form-label">Estado *</label>
                                <select class="form-select" id="producto-estado" required>
                                    <option value="true">Activo</option>
                                    <option value="false">Inactivo</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="producto-imagen" class="form-label">URL de Imagen</label>
                            <input type="text" class="form-control" id="producto-imagen" placeholder="image/pizza.jpg">
                            <div class="form-text">Ruta relativa o URL completa</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Producto</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Extra -->
    <div class="modal fade" id="modalExtra" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="modalExtraLabel">Agregar Extra</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-extra" onsubmit="return guardarExtra(event)">
                    <div class="modal-body">
                        <input type="hidden" id="extra-id">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="extra-nombre" class="form-label">Nombre del Extra *</label>
                                <input type="text" class="form-control" id="extra-nombre" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="extra-precio" class="form-label">Precio (CLP) *</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="extra-precio" min="0" step="100" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="extra-estado" class="form-label">Estado *</label>
                                <select class="form-select" id="extra-estado" required>
                                    <option value="true">Activo</option>
                                    <option value="false">Inactivo</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Productos Asociados</label>
                            <div class="card">
                                <div class="card-body" style="max-height: 200px; overflow-y: auto;">
                                    <div id="lista-productos-check">
                                        <!-- Se llena dinámicamente -->
                                        <div class="text-center text-muted">Cargando productos...</div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-text">Seleccione los productos que pueden llevar este extra.</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-info text-white">Guardar Extra</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Tamaño -->
    <div class="modal fade" id="modalTamanio" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="modalTamanioLabel">Agregar Tamaño</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-tamanio" onsubmit="return guardarTamanio(event)">
                    <div class="modal-body">
                        <input type="hidden" id="tamanio-id">
                        <div class="mb-3">
                            <label for="tamanio-nombre" class="form-label">Nombre del Tamaño *</label>
                            <input type="text" class="form-control" id="tamanio-nombre" required placeholder="Ej: Personal, Mediana, Familiar">
                            <div class="form-text">Nombre descriptivo del tamaño de pizza</div>
                        </div>
                        <div class="mb-3">
                            <label for="tamanio-precio" class="form-label">Precio Adicional (CLP) *</label>
                            <div class="input-group">
                                <span class="input-group-text">+$</span>
                                <input type="number" class="form-control" id="tamanio-precio" min="0" step="100" value="0" required>
                            </div>
                            <div class="form-text">Este valor se sumará al precio base del producto. Use 0 para el tamaño más pequeño.</div>
                        </div>
                        <div class="mb-3">
                            <label for="tamanio-estado" class="form-label">Estado *</label>
                            <select class="form-select" id="tamanio-estado" required>
                                <option value="true">Activo</option>
                                <option value="false">Inactivo</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-warning">Guardar Tamaño</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container text-center small">
            <img src="../image/pizzeria_la_fornace_png.png" alt="La Fornace" width="40" class="mb-2">
            <div>Pizzería La Fornace · Solo entregamos calidad</div>
            <div>© 2025 La Fornace · Todos los derechos reservados</div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script src="../js/api.js"></script>
    <script src="../data/mock-data.js"></script>
    <script src="../scripts.js"></script>
    
    <script>
        let productosActuales = [];
        let productoEditando = null;
        let extrasActuales = [];
        let extraEditando = null;
        let tamaniosActuales = [];
        let tamanioEditando = null;
        let categoriasDisponibles = [];
        
        // Cargar productos al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar autenticación (admin)
            if (typeof api.isAuthenticated === 'function') {
                if (!api.isAuthenticated()) {
                    window.location.href = '../tu-cuenta/login.html';
                    return;
                }
            } else {
                // Fallback si el método no existe aún (cache)
                if (!localStorage.getItem('access_token')) {
                    window.location.href = '../tu-cuenta/login.html';
                    return;
                }
            }
            
            cargarCategorias();
            cargarProductos();
            cargarTamanios();
            cargarExtras();
        });
        
        // ========================================
        // FUNCIONES AUXILIARES
        // ========================================
        
        async function cargarCategorias() {
            try {
                const select = document.getElementById('producto-categoria');
                // Mostrar estado de carga
                select.innerHTML = '<option value="">Cargando categorías...</option>';
                select.disabled = true;

                const categorias = await api.get('/productos/categorias');
                categoriasDisponibles = categorias || [];
                
                select.innerHTML = '<option value="">Seleccione...</option>';
                
                if (categoriasDisponibles.length === 0) {
                    const option = document.createElement('option');
                    option.disabled = true;
                    option.textContent = 'No hay categorías disponibles';
                    select.appendChild(option);
                } else {
                    categoriasDisponibles.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.id;
                        option.textContent = cat.nombre;
                        select.appendChild(option);
                    });
                }
                select.disabled = false;
            } catch (error) {
                console.error('Error al cargar categorías:', error);
                const select = document.getElementById('producto-categoria');
                select.innerHTML = '<option value="">Error al cargar</option>';
                mostrarError('Error de conexión al cargar categorías: ' + error.message);
            }
        }

        // ========================================
        // FUNCIONES PARA EXTRAS
        // ========================================
        
        // Cargar extras desde API
        async function cargarExtras() {
            try {
                const extras = await api.get('/productos/extras/list');
                extrasActuales = extras || [];
                renderizarTablaExtras();
            } catch (error) {
                console.error('Error al cargar extras:', error);
                mostrarError('Error al cargar extras: ' + error.message);
            }
        }
        
        // Renderizar tabla de extras
        function renderizarTablaExtras() {
            const tbody = document.getElementById('extras-tbody');
            if (!tbody) return;
            
            if (!extrasActuales || extrasActuales.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center py-5 text-muted">
                            No hay extras registrados.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = extrasActuales.map(extra => {
                const estadoClase = extra.activo ? 'success' : 'danger';
                const estadoTexto = extra.activo ? 'Activo' : 'Inactivo';
                const accionTexto = extra.activo ? 'Desactivar' : 'Activar';
                const accionClase = extra.activo ? 'btn-warning' : 'btn-success';
                
                let precioFormateado = '$' + extra.precio;
                if (typeof formatearPrecio === 'function') {
                    precioFormateado = formatearPrecio(extra.precio);
                }
                
                return `
                    <tr>
                        <td>
                            <strong>${extra.nombre}</strong>
                        </td>
                        <td class="font-monospace">${precioFormateado}</td>
                        <td class="text-center">
                            <span class="badge bg-${estadoClase}">${estadoTexto}</span>
                        </td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-primary mb-1" onclick="editarExtra(${extra.id})">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-pencil me-1" viewBox="0 0 16 16">
                                    <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                                </svg>
                                Editar
                            </button>
                            <button class="btn btn-sm ${accionClase}" onclick="toggleEstadoExtra(${extra.id}, ${extra.activo})">
                                ${accionTexto}
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Abrir modal para agregar extra
        function abrirModalExtra() {
            extraEditando = null;
            document.getElementById('form-extra').reset();
            document.getElementById('extra-id').value = '';
            document.getElementById('modalExtraLabel').textContent = 'Agregar Extra';
            document.getElementById('extra-estado').value = 'true';
            
            renderizarChecklistProductos();
            
            const modal = new bootstrap.Modal(document.getElementById('modalExtra'));
            modal.show();
        }
        
        // Renderizar checklist de productos para asociar al extra
        function renderizarChecklistProductos(seleccionados = []) {
            const container = document.getElementById('lista-productos-check');
            if (!container) return;
            
            if (productosActuales.length === 0) {
                container.innerHTML = '<div class="text-muted">No hay productos disponibles.</div>';
                return;
            }
            
            let html = '';
            // Agrupar por categoría para facilitar selección
            const productosPorCategoria = {};
            productosActuales.forEach(p => {
                const cat = p.categoria ? p.categoria.nombre : 'Sin Categoría';
                if (!productosPorCategoria[cat]) productosPorCategoria[cat] = [];
                productosPorCategoria[cat].push(p);
            });
            
            for (const [categoria, productos] of Object.entries(productosPorCategoria)) {
                html += `<h6 class="mt-2 mb-1 fw-bold text-primary">${categoria}</h6>`;
                productos.forEach(p => {
                    const isChecked = seleccionados.includes(p.id) ? 'checked' : '';
                    html += `
                        <div class="form-check">
                            <input class="form-check-input producto-check" type="checkbox" value="${p.id}" id="prod-check-${p.id}" ${isChecked}>
                            <label class="form-check-label" for="prod-check-${p.id}">
                                ${p.nombre}
                            </label>
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
        }
        
        // Editar extra
        function editarExtra(id) {
            extraEditando = extrasActuales.find(e => e.id === id);
            if (!extraEditando) return;
            
            document.getElementById('extra-id').value = extraEditando.id;
            document.getElementById('extra-nombre').value = extraEditando.nombre;
            document.getElementById('extra-precio').value = extraEditando.precio;
            document.getElementById('extra-estado').value = extraEditando.activo.toString();
            document.getElementById('modalExtraLabel').textContent = 'Editar Extra';
            
            // Cargar productos asociados (si la API los devuelve, si no, asumimos vacío o todos)
            // Nota: La API actual de listado no devuelve los IDs asociados por defecto para no sobrecargar.
            // Idealmente deberíamos hacer un GET /extras/{id} pero usaremos lo que tenemos.
            // Si no tenemos la info, mostramos todos desmarcados o marcados según lógica.
            // Para simplificar, asumiremos que si editamos, el usuario debe volver a seleccionar o 
            // implementaremos la carga de detalle si es necesario.
            // Por ahora, dejaremos vacío el checklist si no tenemos datos.
            const productosIds = extraEditando.productos_ids || []; 
            renderizarChecklistProductos(productosIds);
            
            const modal = new bootstrap.Modal(document.getElementById('modalExtra'));
            modal.show();
        }
        
        // Guardar extra
        async function guardarExtra(event) {
            event.preventDefault();
            
            const id = document.getElementById('extra-id').value;
            const nombre = document.getElementById('extra-nombre').value.trim();
            const precio = parseFloat(document.getElementById('extra-precio').value);
            const activo = document.getElementById('extra-estado').value === 'true';
            
            // Obtener productos seleccionados
            const checkboxes = document.querySelectorAll('.producto-check:checked');
            const productos_ids = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            const data = {
                nombre,
                precio,
                activo,
                disponible: true,
                productos_ids
            };
            
            try {
                if (id) {
                    await api.put(`/productos/extras/${id}`, data);
                    mostrarExito('Extra actualizado correctamente');
                } else {
                    await api.post('/productos/extras', data);
                    mostrarExito('Extra creado correctamente');
                }
                
                const modalEl = document.getElementById('modalExtra');
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();
                
                cargarExtras();
            } catch (error) {
                console.error('Error al guardar extra:', error);
                mostrarError('Error al guardar extra: ' + (error.detail || error.message));
            }
            
            return false;
        }
        
        // Activar/Desactivar extra
        async function toggleEstadoExtra(id, estadoActual) {
            if (!confirm(`¿Estás seguro de que deseas ${estadoActual ? 'desactivar' : 'activar'} este extra?`)) {
                return;
            }
            
            try {
                if (estadoActual) {
                    await api.delete(`/productos/extras/${id}`);
                } else {
                    // Para reactivar usamos PUT
                    await api.put(`/productos/extras/${id}`, { activo: true });
                }
                
                mostrarExito(`Extra ${!estadoActual ? 'activado' : 'desactivado'} correctamente`);
                cargarExtras();
            } catch (error) {
                console.error('Error al cambiar estado extra:', error);
                mostrarError('Error al cambiar el estado del extra');
            }
        }
        
        // ========================================
        // FUNCIONES PARA TAMAÑOS
        // ========================================
        
        // Cargar tamaños desde API
        async function cargarTamanios() {
            try {
                const tamanios = await api.get('/productos/tamanios/list?solo_activos=false');
                tamaniosActuales = tamanios || [];
                renderizarTablaTamanios();
            } catch (error) {
                console.error('Error al cargar tamaños:', error);
                mostrarError('Error al cargar tamaños: ' + error.message);
            }
        }
        
        // Renderizar tabla de tamaños
        function renderizarTablaTamanios() {
            const tbody = document.getElementById('tamanios-tbody');
            if (!tbody) return;
            
            if (!tamaniosActuales || tamaniosActuales.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center py-5 text-muted">
                            No hay tamaños registrados. Haz clic en "Agregar Tamaño" para comenzar.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = tamaniosActuales.map(tamanio => {
                const estadoClase = tamanio.activo ? 'success' : 'danger';
                const estadoTexto = tamanio.activo ? 'Activo' : 'Inactivo';
                const accionTexto = tamanio.activo ? 'Desactivar' : 'Activar';
                const accionClase = tamanio.activo ? 'btn-warning' : 'btn-success';
                
                let precioFormateado = '+$' + tamanio.precio_adicional;
                if (typeof formatearPrecio === 'function') {
                    precioFormateado = '+' + formatearPrecio(tamanio.precio_adicional);
                }
                
                return `
                    <tr>
                        <td>
                            <strong class="text-capitalize">${tamanio.nombre}</strong>
                        </td>
                        <td class="font-monospace">${precioFormateado}</td>
                        <td class="text-center">
                            <span class="badge bg-${estadoClase}">${estadoTexto}</span>
                        </td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-primary mb-1" onclick="editarTamanio(${tamanio.id})">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-pencil me-1" viewBox="0 0 16 16">
                                    <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                                </svg>
                                Editar
                            </button>
                            <button class="btn btn-sm ${accionClase}" onclick="toggleEstadoTamanio(${tamanio.id}, ${tamanio.activo})">
                                ${accionTexto}
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Abrir modal para agregar tamaño
        function abrirModalTamanio() {
            tamanioEditando = null;
            document.getElementById('form-tamanio').reset();
            document.getElementById('tamanio-id').value = '';
            document.getElementById('modalTamanioLabel').textContent = 'Agregar Tamaño';
            document.getElementById('tamanio-estado').value = 'true';
            document.getElementById('tamanio-precio').value = '0';
            
            const modal = new bootstrap.Modal(document.getElementById('modalTamanio'));
            modal.show();
        }
        
        // Editar tamaño
        function editarTamanio(id) {
            tamanioEditando = tamaniosActuales.find(t => t.id === id);
            if (!tamanioEditando) return;
            
            document.getElementById('tamanio-id').value = tamanioEditando.id;
            document.getElementById('tamanio-nombre').value = tamanioEditando.nombre;
            document.getElementById('tamanio-precio').value = tamanioEditando.precio_adicional;
            document.getElementById('tamanio-estado').value = tamanioEditando.activo.toString();
            document.getElementById('modalTamanioLabel').textContent = 'Editar Tamaño';
            
            const modal = new bootstrap.Modal(document.getElementById('modalTamanio'));
            modal.show();
        }
        
        // Guardar tamaño
        async function guardarTamanio(event) {
            event.preventDefault();
            
            const id = document.getElementById('tamanio-id').value;
            const nombre = document.getElementById('tamanio-nombre').value.trim();
            const precio_adicional = parseFloat(document.getElementById('tamanio-precio').value);
            const activo = document.getElementById('tamanio-estado').value === 'true';
            
            const data = {
                nombre,
                precio_adicional,
                activo
            };
            
            try {
                if (id) {
                    await api.put(`/productos/tamanios/${id}`, data);
                    mostrarExito('Tamaño actualizado correctamente');
                } else {
                    await api.post('/productos/tamanios', data);
                    mostrarExito('Tamaño creado correctamente');
                }
                
                const modalEl = document.getElementById('modalTamanio');
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();
                
                cargarTamanios();
            } catch (error) {
                console.error('Error al guardar tamaño:', error);
                mostrarError('Error al guardar tamaño: ' + (error.detail || error.message));
            }
            
            return false;
        }
        
        // Activar/Desactivar tamaño
        async function toggleEstadoTamanio(id, estadoActual) {
            if (!confirm(`¿Estás seguro de que deseas ${estadoActual ? 'desactivar' : 'activar'} este tamaño?`)) {
                return;
            }
            
            try {
                if (estadoActual) {
                    await api.delete(`/productos/tamanios/${id}`);
                } else {
                    // Para reactivar usamos PUT
                    await api.put(`/productos/tamanios/${id}`, { activo: true });
                }
                
                mostrarExito(`Tamaño ${!estadoActual ? 'activado' : 'desactivado'} correctamente`);
                cargarTamanios();
            } catch (error) {
                console.error('Error al cambiar estado tamaño:', error);
                mostrarError('Error al cambiar el estado del tamaño');
            }
        }
        
        // ========================================
        // FUNCIONES PARA PRODUCTOS
        // ========================================

        // Cargar productos desde API
        async function cargarProductos() {
            try {
                console.log('Iniciando carga de productos...');
                // Obtener todos los productos (sin filtros para admin)
                const productos = await api.get('/productos?solo_disponibles=false&solo_activos=false');
                console.log('Productos recibidos:', productos);
                
                productosActuales = productos || [];
                console.log('Total productos a renderizar:', productosActuales.length);
                
                renderizarTabla();
            } catch (error) {
                console.error('Error al cargar productos:', error);
                mostrarError('Error al cargar productos desde el servidor: ' + error.message);
                
                // Mostrar error en la tabla también
                const tbody = document.getElementById('productos-tbody');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center py-5 text-danger">
                                Error de conexión: ${error.message}
                            </td>
                        </tr>
                    `;
                }
            }
        }
        
        // Renderizar tabla de productos agrupada por categoría
        function renderizarTabla() {
            console.log('Renderizando tabla...');
            try {
                const tbody = document.getElementById('productos-tbody');
                if (!tbody) {
                    console.error('No se encontró el elemento tbody');
                    return;
                }
                
                if (!productosActuales || productosActuales.length === 0) {
                    console.log('No hay productos para mostrar');
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center py-5 text-muted">
                                No hay productos registrados. Haz clic en "Agregar Producto" para comenzar.
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // Agrupar productos por categoría
                const productosPorCategoria = {};
                productosActuales.forEach(p => {
                    // Manejo robusto de categoría nula o indefinida
                    let catNombre = 'Sin Categoría';
                    if (p.categoria && p.categoria.nombre) {
                        catNombre = p.categoria.nombre;
                    }
                    
                    if (!productosPorCategoria[catNombre]) {
                        productosPorCategoria[catNombre] = [];
                    }
                    productosPorCategoria[catNombre].push(p);
                });

                console.log('Productos agrupados:', productosPorCategoria);

                // Ordenar categorías: Pizzas primero, luego Líquidos, luego el resto
                const ordenCategorias = ['Pizzas', 'Líquidos', 'Bebestibles'];
                const categoriasOrdenadas = Object.keys(productosPorCategoria).sort((a, b) => {
                    const indexA = ordenCategorias.indexOf(a);
                    const indexB = ordenCategorias.indexOf(b);
                    
                    if (indexA !== -1 && indexB !== -1) return indexA - indexB;
                    if (indexA !== -1) return -1;
                    if (indexB !== -1) return 1;
                    return a.localeCompare(b);
                });

                let html = '';
                
                categoriasOrdenadas.forEach(catNombre => {
                    // Header de categoría
                    html += `
                        <tr class="table-secondary">
                            <td colspan="6" class="fw-bold text-uppercase small py-2 px-3">
                                ${catNombre}
                            </td>
                        </tr>
                    `;
                    
                    // Productos de la categoría
                    productosPorCategoria[catNombre].forEach(producto => {
                        const estadoClase = producto.activo ? 'success' : 'danger';
                        const estadoTexto = producto.activo ? 'Activo' : 'Inactivo';
                        const accionTexto = producto.activo ? 'Desactivar' : 'Activar';
                        const accionClase = producto.activo ? 'btn-warning' : 'btn-success';
                        
                        // Asegurar que el precio sea un número para el formato correcto
                        let precioFormateado = '$0';
                        try {
                            const precioNum = parseFloat(producto.precio);
                            // Usar formatearPrecio si existe (de mock-data.js o scripts.js)
                            if (!isNaN(precioNum) && typeof formatearPrecio === 'function') {
                                precioFormateado = formatearPrecio(precioNum);
                            } else {
                                precioFormateado = '$' + producto.precio;
                            }
                        } catch (e) {
                            console.warn('Error formateando precio:', e);
                            precioFormateado = '$' + producto.precio;
                        }

                        html += `
                            <tr>
                                <td>
                                    <strong>${producto.nombre}</strong><br>
                                    <small class="text-muted">${producto.descripcion || ''}</small>
                                </td>
                                <td>${catNombre}</td>
                                <td class="font-monospace">${precioFormateado}</td>
                                <td>${producto.stock}</td>
                                <td class="text-center">
                                    <span class="badge bg-${estadoClase}">${estadoTexto}</span>
                                </td>
                                <td class="text-center">
                                    <button class="btn btn-sm btn-primary mb-1" onclick="editarProducto(${producto.id})">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-pencil me-1" viewBox="0 0 16 16">
                                            <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                                        </svg>
                                        Editar
                                    </button>
                                    <button class="btn btn-sm ${accionClase}" onclick="toggleEstadoProducto(${producto.id}, ${producto.activo})">
                                        ${accionTexto}
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                });
                
                tbody.innerHTML = html;
                console.log('Tabla renderizada correctamente');
            } catch (error) {
                console.error('Error al renderizar tabla:', error);
                const tbody = document.getElementById('productos-tbody');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center py-5 text-danger">
                                Error al mostrar productos: ${error.message}
                            </td>
                        </tr>
                    `;
                }
            }
        }
        
        // Abrir modal para agregar producto
        function abrirModalProducto() {
            productoEditando = null;
            document.getElementById('form-producto').reset();
            document.getElementById('producto-id').value = '';
            document.getElementById('modalProductoLabel').textContent = 'Agregar Producto';
            document.getElementById('producto-estado').value = 'true';
            document.getElementById('producto-stock').value = '100';
            
            // Recargar categorías por si acaso falló la carga inicial o estaba vacío
            if (document.getElementById('producto-categoria').options.length <= 1) {
                cargarCategorias();
            }
            
            const modal = new bootstrap.Modal(document.getElementById('modalProducto'));
            modal.show();
        }
        
        // Editar producto
        function editarProducto(id) {
            productoEditando = productosActuales.find(p => p.id === id);
            if (!productoEditando) return;
            
            document.getElementById('producto-id').value = productoEditando.id;
            document.getElementById('producto-nombre').value = productoEditando.nombre;
            document.getElementById('producto-descripcion').value = productoEditando.descripcion || '';
            document.getElementById('producto-precio').value = productoEditando.precio;
            document.getElementById('producto-stock').value = productoEditando.stock;
            document.getElementById('producto-categoria').value = productoEditando.categoria_id;
            document.getElementById('producto-imagen').value = productoEditando.image_url || '';
            document.getElementById('producto-estado').value = productoEditando.activo.toString();
            document.getElementById('modalProductoLabel').textContent = 'Editar Producto';
            
            const modal = new bootstrap.Modal(document.getElementById('modalProducto'));
            modal.show();
        }
        
        // Guardar producto
        async function guardarProducto(event) {
            event.preventDefault();
            
            const id = document.getElementById('producto-id').value;
            const nombre = document.getElementById('producto-nombre').value.trim();
            const descripcion = document.getElementById('producto-descripcion').value.trim();
            const precio = parseFloat(document.getElementById('producto-precio').value);
            const stock = parseInt(document.getElementById('producto-stock').value);
            const categoria_id = parseInt(document.getElementById('producto-categoria').value);
            const image_url = document.getElementById('producto-imagen').value.trim();
            const activo = document.getElementById('producto-estado').value === 'true';
            
            const data = {
                nombre,
                descripcion,
                precio,
                stock,
                categoria_id,
                image_url,
                activo,
                disponible: stock > 0
            };
            
            try {
                if (id) {
                    // Editar existente
                    await api.put(`/productos/${id}`, data);
                    mostrarExito('Producto actualizado correctamente');
                } else {
                    // Crear nuevo
                    await api.post('/productos', data);
                    mostrarExito('Producto creado correctamente');
                }
                
                // Cerrar modal
                const modalEl = document.getElementById('modalProducto');
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();
                
                // Recargar tabla
                cargarProductos();
                
            } catch (error) {
                console.error('Error al guardar producto:', error);
                mostrarError('Error al guardar el producto: ' + (error.detail || error.message));
            }
            
            return false;
        }
        
        // Activar/Desactivar producto
        async function toggleEstadoProducto(id, estadoActual) {
            if (!confirm(`¿Estás seguro de que deseas ${estadoActual ? 'desactivar' : 'activar'} este producto?`)) {
                return;
            }
            
            try {
                // Usamos PUT para actualizar solo el estado activo
                // Nota: El endpoint DELETE en la API actual solo desactiva, pero para reactivar necesitamos PUT
                await api.put(`/productos/${id}`, { activo: !estadoActual });
                
                mostrarExito(`Producto ${!estadoActual ? 'activado' : 'desactivado'} correctamente`);
                cargarProductos();
            } catch (error) {
                console.error('Error al cambiar estado:', error);
                mostrarError('Error al cambiar el estado del producto');
            }
        }
    </script>
</body>
</html>


