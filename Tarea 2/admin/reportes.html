<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Reportes de Ventas - La Fornace Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="../styles.css">
    <link rel="icon" type="image/png" href="../image/pizzeria_la_fornace_png.png">
</head>
<body class="bg-cream">
    <!-- Historia: B-09 Reporte de Ventas + B-11 Exportación PDF -->
    
    <nav class="navbar navbar-expand-lg navbar-dark bg-fornace sticky-top shadow-sm">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="../index.html">
                <img src="../image/pizzeria_la_fornace_png.png" alt="La Fornace" width="56" height="56" class="me-2">
                <span>La Fornace Admin</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="mainNav">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="productos.html">Productos</a></li>
                    <li class="nav-item"><a class="nav-link" href="cocina.html">Cocina</a></li>
                    <li class="nav-item"><a class="nav-link active" href="reportes.html">Reportes</a></li>
                    <li class="nav-item"><a class="nav-link" href="ranking.html">Ranking</a></li>
                    <li class="nav-item"><a class="nav-link" href="notificaciones.html">Notificaciones</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container py-5">
        <div class="row">
            <div class="col-12">
                <h2 class="mb-4">Reporte de Ventas</h2>
                
                <div id="mensaje-container"></div>

                <!-- Filtros -->
                <div class="card mb-4 shadow-sm border-0">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Filtros</h5>
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label for="fecha-desde" class="form-label">Desde</label>
                                <input type="date" class="form-control" id="fecha-desde">
                            </div>
                            <div class="col-md-3">
                                <label for="fecha-hasta" class="form-label">Hasta</label>
                                <input type="date" class="form-control" id="fecha-hasta">
                            </div>
                            <div class="col-md-3">
                                <label for="periodo" class="form-label">Período</label>
                                <select class="form-select" id="periodo">
                                    <option value="dia">Día</option>
                                    <option value="semana">Semana</option>
                                    <option value="mes" selected>Mes</option>
                                </select>
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button class="btn btn-success w-100" onclick="generarReporte()">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bar-chart-fill me-1" viewBox="0 0 16 16">
                                        <path d="M1 11a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1v-3zm5-4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7zm5-5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V2z"/>
                                    </svg>
                                    Generar Reporte
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Métricas -->
                <div id="metricas-container" style="display: none;">
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <div class="card shadow-sm border-0 border-start border-success border-4 h-100">
                                <div class="card-body text-center">
                                    <h6 class="text-muted mb-2">Ventas Totales</h6>
                                    <h3 class="text-success mb-1" id="metric-ventas">$0</h3>
                                    <small class="text-muted" id="metric-ventas-cambio"></small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card shadow-sm border-0 border-start border-primary border-4 h-100">
                                <div class="card-body text-center">
                                    <h6 class="text-muted mb-2">Pedidos Totales</h6>
                                    <h3 class="text-primary mb-1" id="metric-pedidos">0</h3>
                                    <small class="text-muted" id="metric-pedidos-cambio"></small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card shadow-sm border-0 border-start border-warning border-4 h-100">
                                <div class="card-body text-center">
                                    <h6 class="text-muted mb-2">Ticket Promedio</h6>
                                    <h3 class="text-warning mb-1" id="metric-promedio">$0</h3>
                                    <small class="text-muted" id="metric-promedio-cambio"></small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Detalle de Ventas -->
                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Tendencias de Ventas</h5>
                            <button class="btn btn-sm btn-danger" onclick="exportarPDF()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-pdf me-1" viewBox="0 0 16 16">
                                    <path d="M4 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H4zm0 1h8a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1z"/>
                                    <path d="M4.603 12.087a.81.81 0 0 1-.438-.42c-.195-.388-.13-.776.08-1.102.198-.307.526-.568.897-.787a7.68 7.68 0 0 1 1.482-.645 19.701 19.701 0 0 0 1.062-2.227 7.269 7.269 0 0 1-.43-1.295c-.086-.4-.119-.796-.046-1.136.075-.354.274-.672.65-.823.192-.077.4-.12.602-.077a.7.7 0 0 1 .477.365c.088.164.12.356.127.538.007.187-.012.395-.047.614-.084.51-.27 1.134-.52 1.794a10.954 10.954 0 0 0 .98 1.686 5.753 5.753 0 0 1 1.334.05c.364.065.734.195.96.465.12.144.193.32.2.518.007.192-.047.382-.138.563a1.04 1.04 0 0 1-.354.416.856.856 0 0 1-.51.138c-.331-.014-.654-.196-.933-.417a5.716 5.716 0 0 1-.911-.95 11.642 11.642 0 0 0-1.997.406 11.311 11.311 0 0 1-1.021 1.51c-.29.35-.608.655-.926.787a.793.793 0 0 1-.58.029zm1.379-1.901c-.166.076-.32.156-.459.238-.328.194-.541.383-.647.547-.094.145-.096.25-.04.361.01.022.02.036.026.044a.27.27 0 0 0 .035-.012c.137-.056.355-.235.635-.572a8.18 8.18 0 0 0 .45-.606zm1.64-1.33a12.647 12.647 0 0 1 1.01-.193 11.666 11.666 0 0 1-.51-.858 20.741 20.741 0 0 1-.5 1.05zm2.446.45c.15.162.296.3.435.41.24.19.407.253.498.256a.107.107 0 0 0 .07-.015.307.307 0 0 0 .094-.125.436.436 0 0 0 .059-.2.095.095 0 0 0-.026-.063c-.052-.062-.2-.152-.518-.209a3.881 3.881 0 0 0-.612-.053zM8.078 5.8a6.7 6.7 0 0 0 .2-.828c.031-.188.043-.343.038-.465a.613.613 0 0 0-.032-.198.517.517 0 0 0-.145.04c-.087.035-.158.106-.196.283-.04.192-.03.469.046.822.024.111.054.227.09.346z"/>
                                </svg>
                                Exportar PDF
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="tendencias-container">
                                <!-- Se llena dinámicamente -->
                            </div>
                        </div>
                    </div>

                    <!-- Tabla de Pedidos Detallada -->
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-white">
                            <h5 class="mb-0">Pedidos del Período</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Pedido #</th>
                                            <th>Fecha</th>
                                            <th>Estado</th>
                                            <th>Items</th>
                                            <th class="text-end">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabla-pedidos">
                                        <!-- Se llena dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Estado sin datos -->
                <div id="sin-datos" class="text-center py-5">
                    <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" fill="currentColor" class="bi bi-graph-up text-muted mb-3" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M0 0h1v15h15v1H0V0Zm14.817 3.113a.5.5 0 0 1 .07.704l-4.5 5.5a.5.5 0 0 1-.74.037L7.06 6.767l-3.656 5.027a.5.5 0 0 1-.808-.588l4-5.5a.5.5 0 0 1 .758-.06l2.609 2.61 4.15-5.073a.5.5 0 0 1 .704-.07Z"/>
                    </svg>
                    <h4 class="text-muted">Selecciona un período para generar el reporte</h4>
                    <p class="text-muted">Utiliza los filtros arriba para analizar tus ventas</p>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container text-center small">
            <img src="../image/pizzeria_la_fornace_png.png" alt="La Fornace" width="40" class="mb-2">
            <div>Pizzería La Fornace · Solo entregamos calidad</div>
            <div>© 2025 La Fornace · Todos los derechos reservados</div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script src="../data/mock-data.js"></script>
    <script src="../scripts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
        let datosReporte = null;

        // Inicializar fechas por defecto
        document.addEventListener('DOMContentLoaded', function() {
            const hoy = new Date();
            const hace30Dias = new Date();
            hace30Dias.setDate(hoy.getDate() - 30);
            
            document.getElementById('fecha-hasta').valueAsDate = hoy;
            document.getElementById('fecha-desde').valueAsDate = hace30Dias;
        });

        // Generar reporte
        function generarReporte() {
            const fechaDesde = document.getElementById('fecha-desde').value;
            const fechaHasta = document.getElementById('fecha-hasta').value;
            const periodo = document.getElementById('periodo').value;
            
            if (!fechaDesde || !fechaHasta) {
                mostrarError('Por favor selecciona ambas fechas');
                return;
            }
            
            if (new Date(fechaDesde) > new Date(fechaHasta)) {
                mostrarError('La fecha "Desde" debe ser anterior a la fecha "Hasta"');
                return;
            }
            
            // Obtener pedidos del localStorage
            const pedidos = JSON.parse(localStorage.getItem('pedidosLaFornace') || '[]');
            
            // Filtrar pedidos por rango de fechas y que no estén anulados
            const pedidosFiltrados = pedidos.filter(p => {
                const fechaPedido = new Date(p.fecha);
                const desde = new Date(fechaDesde);
                const hasta = new Date(fechaHasta);
                hasta.setHours(23, 59, 59);
                
                return fechaPedido >= desde && fechaPedido <= hasta && p.estado !== 'anulado';
            });
            
            if (pedidosFiltrados.length === 0) {
                mostrarInfo('No hay pedidos en el período seleccionado');
                document.getElementById('metricas-container').style.display = 'none';
                document.getElementById('sin-datos').style.display = 'block';
                return;
            }
            
            // Calcular métricas
            const ventasTotales = pedidosFiltrados.reduce((sum, p) => sum + p.total, 0);
            const pedidosTotales = pedidosFiltrados.length;
            const ticketPromedio = ventasTotales / pedidosTotales;
            
            // Guardar datos para export PDF
            datosReporte = {
                fechaDesde,
                fechaHasta,
                periodo,
                ventasTotales,
                pedidosTotales,
                ticketPromedio,
                pedidos: pedidosFiltrados
            };
            
            // Actualizar métricas
            document.getElementById('metric-ventas').textContent = formatearPrecio(ventasTotales);
            document.getElementById('metric-pedidos').textContent = pedidosTotales + ' pedidos';
            document.getElementById('metric-promedio').textContent = formatearPrecio(ticketPromedio);
            
            // Generar tendencias
            generarTendencias(pedidosFiltrados, periodo);
            
            // Llenar tabla
            llenarTablaPedidos(pedidosFiltrados);
            
            // Mostrar resultados
            document.getElementById('sin-datos').style.display = 'none';
            document.getElementById('metricas-container').style.display = 'block';
            
            mostrarExito(`Reporte generado: ${pedidosTotales} pedidos encontrados`);
        }

        // Generar tendencias
        function generarTendencias(pedidos, periodo) {
            const container = document.getElementById('tendencias-container');
            
            // Agrupar por período
            const grupos = {};
            pedidos.forEach(p => {
                const fecha = new Date(p.fecha);
                let clave;
                
                if (periodo === 'dia') {
                    clave = p.fecha;
                } else if (periodo === 'semana') {
                    const semana = obtenerSemana(fecha);
                    clave = `Semana ${semana}`;
                } else { // mes
                    clave = fecha.toLocaleString('es', { month: 'long', year: 'numeric' });
                }
                
                if (!grupos[clave]) {
                    grupos[clave] = { pedidos: 0, ventas: 0 };
                }
                grupos[clave].pedidos++;
                grupos[clave].ventas += p.total;
            });
            
            // Generar HTML de tendencias
            let html = '<div class="row g-3">';
            Object.keys(grupos).forEach(clave => {
                const datos = grupos[clave];
                const promedio = datos.ventas / datos.pedidos;
                
                html += `
                    <div class="col-md-6 col-lg-4">
                        <div class="card border-0 bg-light h-100">
                            <div class="card-body">
                                <h6 class="text-muted mb-2">${clave}</h6>
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <span class="text-muted small">Pedidos:</span>
                                    <strong>${datos.pedidos}</strong>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <span class="text-muted small">Ventas:</span>
                                    <strong class="text-success">${formatearPrecio(datos.ventas)}</strong>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="text-muted small">Promedio:</span>
                                    <strong>${formatearPrecio(promedio)}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        // Llenar tabla de pedidos
        function llenarTablaPedidos(pedidos) {
            const tbody = document.getElementById('tabla-pedidos');
            
            tbody.innerHTML = pedidos.map(p => {
                const estadoInfo = obtenerInfoEstado(p.estado);
                const resumenItems = p.items.map(i => `${i.cantidad}x ${i.nombre}`).join(', ');
                
                return `
                    <tr>
                        <td><strong>#${p.id}</strong></td>
                        <td>${formatearFecha(p.fecha)}</td>
                        <td><span class="badge ${estadoInfo.clase}">${estadoInfo.texto}</span></td>
                        <td><small>${resumenItems}</small></td>
                        <td class="text-end"><strong>${formatearPrecio(p.total)}</strong></td>
                    </tr>
                `;
            }).join('');
        }

        // Obtener número de semana del año
        function obtenerSemana(fecha) {
            const primerDia = new Date(fecha.getFullYear(), 0, 1);
            const dias = Math.floor((fecha - primerDia) / (24 * 60 * 60 * 1000));
            return Math.ceil((dias + primerDia.getDay() + 1) / 7);
        }

        // Obtener información del estado
        function obtenerInfoEstado(estado) {
            const estados = {
                'confirmado': { texto: 'Confirmado', clase: 'bg-primary' },
                'en_preparacion': { texto: 'En Preparación', clase: 'bg-warning text-dark' },
                'en_camino': { texto: 'En Camino', clase: 'bg-info' },
                'entregado': { texto: 'Entregado', clase: 'bg-success' },
                'anulado': { texto: 'Anulado', clase: 'bg-danger' }
            };
            return estados[estado] || { texto: estado, clase: 'bg-secondary' };
        }

        // Exportar a PDF (B-11)
        function exportarPDF() {
            if (!datosReporte) {
                mostrarError('Primero genera un reporte');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Título
            doc.setFontSize(18);
            doc.text('Pizzería La Fornace', 105, 20, { align: 'center' });
            doc.setFontSize(14);
            doc.text('Reporte de Ventas', 105, 28, { align: 'center' });
            
            // Información del período
            doc.setFontSize(10);
            doc.text(`Período: ${formatearFecha(datosReporte.fechaDesde)} - ${formatearFecha(datosReporte.fechaHasta)}`, 20, 40);
            doc.text(`Generado: ${new Date().toLocaleString('es')}`, 20, 46);
            
            // Métricas principales
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('Resumen de Métricas', 20, 58);
            
            doc.setFont(undefined, 'normal');
            doc.setFontSize(10);
            doc.text(`Ventas Totales: ${formatearPrecio(datosReporte.ventasTotales)}`, 20, 66);
            doc.text(`Pedidos Totales: ${datosReporte.pedidosTotales} pedidos`, 20, 72);
            doc.text(`Ticket Promedio: ${formatearPrecio(datosReporte.ticketPromedio)}`, 20, 78);
            
            // Detalle de pedidos
            doc.setFont(undefined, 'bold');
            doc.setFontSize(12);
            doc.text('Detalle de Pedidos', 20, 90);
            
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            
            let y = 98;
            datosReporte.pedidos.forEach((p, index) => {
                if (y > 270) { // Nueva página si es necesario
                    doc.addPage();
                    y = 20;
                }
                
                const estadoInfo = obtenerInfoEstado(p.estado);
                doc.text(`#${p.id} - ${formatearFecha(p.fecha)} - ${estadoInfo.texto} - ${formatearPrecio(p.total)}`, 20, y);
                y += 6;
            });
            
            // Footer
            const totalPages = doc.internal.pages.length - 1;
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.text(`Página ${i} de ${totalPages}`, 105, 290, { align: 'center' });
            }
            
            // Descargar
            doc.save(`reporte-ventas-${datosReporte.fechaDesde}-${datosReporte.fechaHasta}.pdf`);
            mostrarExito('Reporte PDF descargado exitosamente');
        }
    </script>
</body>
</html>



