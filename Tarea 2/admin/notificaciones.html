<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Notificaciones Segmentadas - La Fornace Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="../styles.css">
    <link rel="icon" type="image/png" href="../image/pizzeria_la_fornace_png.png">
</head>
<body class="bg-cream">
    <!-- Historia: B-14 Envío Masivo de Notificaciones Segmentadas -->
    
    <nav class="navbar navbar-expand-lg navbar-dark bg-fornace sticky-top shadow-sm">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="../index.html">
                <img src="../image/pizzeria_la_fornace_png.png" alt="La Fornace" width="56" height="56" class="me-2">
                <span>La Fornace Admin</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="mainNav">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="productos.html">Productos</a></li>
                    <li class="nav-item"><a class="nav-link" href="cocina.html">Cocina</a></li>
                    <li class="nav-item"><a class="nav-link" href="reportes.html">Reportes</a></li>
                    <li class="nav-item"><a class="nav-link" href="ranking.html">Ranking</a></li>
                    <li class="nav-item"><a class="nav-link active" href="notificaciones.html">Notificaciones</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container py-5">
        <div class="row">
            <div class="col-12">
                <h2 class="mb-4">Envío Masivo Segmentado</h2>
                
                <div id="mensaje-container"></div>

                <!-- Contenido de la Campaña -->
                <div class="card mb-4 shadow-sm border-0">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">Contenido de la Campaña</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="asunto-campana" class="form-label">Asunto</label>
                            <input type="text" class="form-control" id="asunto-campana" placeholder="Ej: Oferta Especial de Fin de Año">
                        </div>
                        <div class="mb-3">
                            <label for="mensaje-campana" class="form-label">Mensaje</label>
                            <textarea class="form-control" id="mensaje-campana" rows="4" placeholder="Contenido de la notificación..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Criterios de Segmentación -->
                <div class="card mb-4 shadow-sm border-0">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">Criterios de Segmentación</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="segmento-tipo" class="form-label">Tipo de Segmento</label>
                                <select class="form-select" id="segmento-tipo">
                                    <option value="todos">Todos los clientes</option>
                                    <option value="suscritos">Solo suscritos a promociones</option>
                                    <option value="activos">Clientes activos (compras recientes)</option>
                                    <option value="inactivos">Clientes inactivos (sin compras)</option>
                                    <option value="premium">Clientes Premium (alto volumen)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="periodo-actividad" class="form-label">Período de Actividad</label>
                                <select class="form-select" id="periodo-actividad">
                                    <option value="30">Últimos 30 días</option>
                                    <option value="90">Últimos 3 meses</option>
                                    <option value="180">Últimos 6 meses</option>
                                    <option value="365">Último año</option>
                                    <option value="todos">Todos los períodos</option>
                                </select>
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <button class="btn btn-primary" onclick="calcularSegmento()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-calculator me-1" viewBox="0 0 16 16">
                                <path d="M12 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h8zM4 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H4z"/>
                                <path d="M4 2.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.5.5h-7a.5.5 0 0 1-.5-.5v-2zm0 4a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm3-6a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm3-6a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-4z"/>
                            </svg>
                            Calcular Segmento
                        </button>
                        
                        <!-- Resultados del Segmento -->
                        <div id="resultados-segmento" style="display: none;" class="mt-4">
                            <div class="alert alert-info">
                                <div class="row">
                                    <div class="col-md-4 text-center">
                                        <h3 class="mb-0" id="total-clientes">0</h3>
                                        <small>Clientes en segmento</small>
                                    </div>
                                    <div class="col-md-4 text-center border-start border-end">
                                        <h3 class="mb-0 text-success" id="clientes-elegibles">0</h3>
                                        <small>Clientes elegibles</small>
                                    </div>
                                    <div class="col-md-4 text-center">
                                        <h3 class="mb-0 text-danger" id="clientes-excluidos">0</h3>
                                        <small>Excluidos automáticamente</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Exclusiones Automáticas -->
                <div class="card mb-4 shadow-sm border-0">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">Exclusiones Automáticas</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning mb-0">
                            <h6 class="alert-heading">Los siguientes clientes serán excluidos automáticamente:</h6>
                            <ul class="mb-0">
                                <li>Clientes que optaron por no recibir promociones</li>
                                <li>Usuarios sin pedidos en los últimos 6 meses (inactivos)</li>
                                <li>Clientes con estado de cuenta suspendido</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Vista Previa y Envío -->
                <div id="seccion-envio" style="display: none;">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-white">
                            <h5 class="mb-0">Vista Previa y Envío</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Resumen de la Campaña:</h6>
                                    <ul>
                                        <li><strong>Asunto:</strong> <span id="preview-asunto">-</span></li>
                                        <li><strong>Segmento:</strong> <span id="preview-segmento">-</span></li>
                                        <li><strong>Destinatarios:</strong> <span id="preview-destinatarios">0</span> clientes</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <div class="border rounded p-3 bg-light">
                                        <h6 class="text-muted">Mensaje:</h6>
                                        <p id="preview-mensaje" class="mb-0">-</p>
                                    </div>
                                </div>
                            </div>
                            
                            <hr>
                            
                            <div class="d-flex justify-content-between align-items-center">
                                <button class="btn btn-secondary" onclick="limpiarFormulario()">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-counterclockwise me-1" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M8 3a5 5 0 1 1-4.546 2.914.5.5 0 0 0-.908-.417A6 6 0 1 0 8 2v1z"/>
                                        <path d="M8 4.466V.534a.25.25 0 0 0-.41-.192L5.23 2.308a.25.25 0 0 0 0 .384l2.36 1.966A.25.25 0 0 0 8 4.466z"/>
                                    </svg>
                                    Limpiar
                                </button>
                                <button class="btn btn-danger btn-lg" onclick="enviarCampana()">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-send-fill me-2" viewBox="0 0 16 16">
                                        <path d="M15.964.686a.5.5 0 0 0-.65-.65L.767 5.855H.766l-.452.18a.5.5 0 0 0-.082.887l.41.26.001.002 4.995 3.178 3.178 4.995.002.002.26.41a.5.5 0 0 0 .886-.083l6-15Zm-1.833 1.89L6.637 10.07l-.215-.338a.5.5 0 0 0-.154-.154l-.338-.215 7.494-7.494 1.178-.471-.47 1.178Z"/>
                                    </svg>
                                    Enviar Campaña
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container text-center small">
            <img src="../image/pizzeria_la_fornace_png.png" alt="La Fornace" width="40" class="mb-2">
            <div>Pizzería La Fornace · Solo entregamos calidad</div>
            <div>© 2025 La Fornace · Todos los derechos reservados</div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script src="../data/mock-data.js"></script>
    <script src="../scripts.js"></script>
    
    <script>
        let segmentoActual = null;

        // Calcular segmento de clientes
        function calcularSegmento() {
            const tipoSegmento = document.getElementById('segmento-tipo').value;
            const periodoActividad = parseInt(document.getElementById('periodo-actividad').value);
            
            // Obtener el estado de suscripción actualizado del usuario desde localStorage
            const usuarioActualizado = JSON.parse(localStorage.getItem('usuarioLaFornace') || JSON.stringify(usuario));
            
            // Obtener todos los pedidos
            const pedidos = JSON.parse(localStorage.getItem('pedidosLaFornace') || '[]');
            
            // Crear base de clientes desde datos reales
            // En una app real vendría del backend con IDs de cliente reales
            let clientes = [];
            
            if (pedidos.length > 0) {
                // Usuario actual (agrupa TODOS sus pedidos)
                const totalGastado = pedidos.reduce((sum, p) => sum + p.total, 0);
                const fechaMasReciente = new Date(Math.max(...pedidos.map(p => new Date(p.fecha).getTime())));
                
                clientes.push({
                    id: 1, 
                    nombre: usuarioActualizado.nombre || "Usuario Actual",
                    suscritoPromos: usuarioActualizado.suscritoPromos,
                    ultimoPedido: fechaMasReciente,
                    totalGastado: totalGastado,
                    cantidadPedidos: pedidos.length
                });
            } else {
                // Si no hay pedidos, al menos incluir al usuario actual
                clientes = [{
                    id: 1, 
                    nombre: usuarioActualizado.nombre || "Usuario Actual",
                    suscritoPromos: usuarioActualizado.suscritoPromos, 
                    ultimoPedido: new Date(), 
                    totalGastado: 0, 
                    cantidadPedidos: 0 
                }];
            }
            
            // Aplicar filtros de segmentación
            let clientesFiltrados = clientes;
            
            // Filtro por tipo de segmento
            switch (tipoSegmento) {
                case 'suscritos':
                    clientesFiltrados = clientesFiltrados.filter(c => c.suscritoPromos);
                    break;
                case 'activos':
                    const diasActivos = periodoActividad === 'todos' ? 365 : periodoActividad;
                    const fechaLimite = new Date();
                    fechaLimite.setDate(fechaLimite.getDate() - diasActivos);
                    clientesFiltrados = clientesFiltrados.filter(c => c.ultimoPedido >= fechaLimite);
                    break;
                case 'inactivos':
                    const fechaInactivo = new Date();
                    fechaInactivo.setDate(fechaInactivo.getDate() - 180);
                    clientesFiltrados = clientesFiltrados.filter(c => c.ultimoPedido < fechaInactivo);
                    break;
                case 'premium':
                    clientesFiltrados = clientesFiltrados.filter(c => c.totalGastado > 100000 || c.cantidadPedidos > 10);
                    break;
            }
            
            // Aplicar exclusiones automáticas
            const fechaInactivo = new Date();
            fechaInactivo.setMonth(fechaInactivo.getMonth() - 6);
            
            const clientesElegibles = clientesFiltrados.filter(c => {
                return c.suscritoPromos && c.ultimoPedido >= fechaInactivo;
            });
            
            const clientesExcluidos = clientesFiltrados.length - clientesElegibles.length;
            
            // Guardar segmento actual
            segmentoActual = {
                tipo: tipoSegmento,
                periodo: periodoActividad,
                total: clientesFiltrados.length,
                elegibles: clientesElegibles.length,
                excluidos: clientesExcluidos,
                clientes: clientesElegibles
            };
            
            // Actualizar UI
            document.getElementById('total-clientes').textContent = clientesFiltrados.length;
            document.getElementById('clientes-elegibles').textContent = clientesElegibles.length;
            document.getElementById('clientes-excluidos').textContent = clientesExcluidos;
            
            document.getElementById('resultados-segmento').style.display = 'block';
            document.getElementById('seccion-envio').style.display = 'block';
            
            // Actualizar preview
            actualizarPreview();
            
            mostrarExito(`Segmento calculado: ${clientesElegibles.length} clientes elegibles`);
        }

        // Actualizar vista previa
        function actualizarPreview() {
            const asunto = document.getElementById('asunto-campana').value || '-';
            const mensaje = document.getElementById('mensaje-campana').value || '-';
            const tipoSegmento = document.getElementById('segmento-tipo').selectedOptions[0].text;
            
            document.getElementById('preview-asunto').textContent = asunto;
            document.getElementById('preview-mensaje').textContent = mensaje;
            document.getElementById('preview-segmento').textContent = tipoSegmento;
            document.getElementById('preview-destinatarios').textContent = segmentoActual ? segmentoActual.elegibles : 0;
        }

        // Actualizar preview cuando cambian los campos
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('asunto-campana').addEventListener('input', actualizarPreview);
            document.getElementById('mensaje-campana').addEventListener('input', actualizarPreview);
        });

        // Enviar campaña
        function enviarCampana() {
            const asunto = document.getElementById('asunto-campana').value.trim();
            const mensaje = document.getElementById('mensaje-campana').value.trim();
            
            if (!asunto) {
                mostrarError('Por favor ingresa un asunto para la campaña');
                return;
            }
            
            if (!mensaje) {
                mostrarError('Por favor ingresa un mensaje para la campaña');
                return;
            }
            
            if (!segmentoActual || segmentoActual.elegibles === 0) {
                mostrarError('Primero calcula el segmento y asegúrate de tener clientes elegibles');
                return;
            }
            
            // Simular envío de campaña
            const campana = {
                id: Date.now(),
                asunto: asunto,
                mensaje: mensaje,
                segmento: segmentoActual.tipo,
                destinatarios: segmentoActual.elegibles,
                excluidos: segmentoActual.excluidos,
                fecha: new Date().toISOString(),
                estado: 'enviado'
            };
            
            // Guardar campaña en localStorage
            const campanas = JSON.parse(localStorage.getItem('campanasLaFornace') || '[]');
            campanas.push(campana);
            localStorage.setItem('campanasLaFornace', JSON.stringify(campanas));
            
            // Mensaje de éxito con detalles
            mostrarExito(`
                Campaña enviada exitosamente a ${segmentoActual.elegibles} clientes<br>
                <small>Excluidos automáticamente: ${segmentoActual.excluidos} clientes</small>
            `);
            
            // Limpiar después de 3 segundos
            setTimeout(() => {
                limpiarFormulario();
            }, 3000);
        }

        // Limpiar formulario
        function limpiarFormulario() {
            document.getElementById('asunto-campana').value = '';
            document.getElementById('mensaje-campana').value = '';
            document.getElementById('segmento-tipo').value = 'todos';
            document.getElementById('periodo-actividad').value = '30';
            document.getElementById('resultados-segmento').style.display = 'none';
            document.getElementById('seccion-envio').style.display = 'none';
            segmentoActual = null;
            
            const mensajeContainer = document.getElementById('mensaje-container');
            if (mensajeContainer) {
                mensajeContainer.innerHTML = '';
            }
        }
    </script>
</body>
</html>





