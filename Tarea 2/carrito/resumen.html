<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Resumen del Pedido - La Fornace</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="../styles.css">
    <link rel="icon" type="image/png" href="../image/pizzeria_la_fornace_png.png">
</head>
<body class="bg-cream">
    <!-- Historia: B-04 Resumen y Confirmación de Pedido -->
    
    <nav class="navbar navbar-expand-lg navbar-dark bg-fornace sticky-top shadow-sm">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="../index.html">
                <img src="../image/pizzeria_la_fornace_png.png" alt="La Fornace" width="56" height="56" class="me-2">
                <span>La Fornace</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="mainNav">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="../index.html">Menú</a></li>
                    <li class="nav-item"><a class="nav-link" href="../tu-cuenta/index.html">Tu Cuenta</a></li>
                    <li class="nav-item">
                        <a class="btn btn-sm btn-primary ms-lg-3 active" href="index.html">
                            Carrito <span class="badge text-bg-light ms-1" id="carrito-badge">0</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container py-5">
        <div class="row">
            <div class="col-12 col-lg-8 mx-auto">
                <h2 class="mb-4">Resumen de tu Pedido</h2>
                
                <!-- Contenedor de mensajes -->
                <div id="mensaje-container"></div>
                
                <!-- Resumen de items -->
                <div class="card mb-4">
                    <div class="card-header bg-fornace text-white">
                        <h5 class="mb-0">Items del Pedido</h5>
                    </div>
                    <div class="card-body" id="items-resumen">
                        <!-- Se llenan dinámicamente -->
                    </div>
                </div>
                
                <!-- Información de entrega -->
                <div class="card mb-4">
                    <div class="card-header bg-fornace text-white">
                        <h5 class="mb-0">Información de Entrega</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label fw-bold">Dirección de Entrega</label>
                                <p class="mb-0" id="direccion-entrega"></p>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Teléfono</label>
                                <p class="mb-0" id="telefono-entrega"></p>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Tiempo Estimado</label>
                                <p class="mb-0 text-primary">
                                    <strong id="eta-entrega">25-30 minutos</strong>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Resumen de costos -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal</span>
                            <span id="resumen-subtotal">$0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Costo de Envío</span>
                            <span id="resumen-envio">$2.500</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2 text-success">
                            <span>Descuento</span>
                            <span id="resumen-descuento">-$0</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between align-items-center">
                            <h4 class="mb-0">Total</h4>
                            <h4 class="mb-0 text-primary" id="resumen-total">$0</h4>
                        </div>
                    </div>
                </div>
                
                <!-- Botones de acción -->
                <div class="d-grid gap-2 d-md-flex justify-content-md-between">
                    <a href="index.html" class="btn btn-outline-secondary btn-lg">
                        Volver al Carrito
                    </a>
                    <button class="btn btn-primary btn-lg" onclick="confirmarPedido()">
                        Confirmar Pedido
                    </button>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container text-center small">
            <img src="../image/pizzeria_la_fornace_png.png" alt="La Fornace" width="40" class="mb-2">
            <div>Pizzería La Fornace · Solo entregamos calidad</div>
            <div>© 2025 La Fornace · Todos los derechos reservados</div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script src="../data/mock-data.js"></script>
    <script src="../scripts.js"></script>
    
    <script>
      // Costo de envío fijo
      const COSTO_ENVIO = 2500;
      
      // ========================================
      // RENDERIZAR RESUMEN DE ITEMS
      // ========================================
      function renderizarResumen() {
        const carritoActual = cargarCarrito();
        const itemsContainer = document.getElementById('items-resumen');
        
        // Si el carrito está vacío, redirigir al carrito
        if (carritoActual.length === 0) {
          window.location.href = 'index.html';
          return;
        }
        
        itemsContainer.innerHTML = '';
        
        carritoActual.forEach(item => {
          const itemDiv = document.createElement('div');
          itemDiv.className = 'd-flex justify-content-between align-items-center mb-3 pb-3 border-bottom';
          
          itemDiv.innerHTML = `
            <div class="d-flex align-items-center">
              <img src="../${item.imagen}" class="rounded me-3" width="60" height="60" style="object-fit: cover;" alt="${item.nombre}">
              <div>
                <h6 class="mb-1">${item.nombre}</h6>
                <small class="text-muted text-capitalize">Tamaño: ${item.tamaño}</small>
                ${item.extras && item.extras.length > 0 ? `
                  <br>
                  <small class="text-muted">Extras: ${item.extras.map(extra => extra.nombre).join(', ')}</small>
                ` : ''}
                <br>
                <small class="text-muted">Cantidad: ${item.cantidad}</small>
              </div>
            </div>
            <div class="text-end">
              <div class="fw-bold">${formatearPrecio(item.precio * item.cantidad)}</div>
              <small class="text-muted">${formatearPrecio(item.precio)} c/u</small>
            </div>
          `;
          
          itemsContainer.appendChild(itemDiv);
        });
        
        // Cargar información de entrega desde mock-data
        document.getElementById('direccion-entrega').textContent = usuario.direccion;
        document.getElementById('telefono-entrega').textContent = usuario.telefono;
        
        // Calcular totales
        actualizarTotalesResumen();
      }
      
      // ========================================
      // ACTUALIZAR TOTALES DEL RESUMEN
      // ========================================
      function actualizarTotalesResumen() {
        const subtotal = calcularTotalCarrito();
        const envio = COSTO_ENVIO;
        const descuento = 0; // Por ahora sin descuentos
        const total = subtotal + envio - descuento;
        
        document.getElementById('resumen-subtotal').textContent = formatearPrecio(subtotal);
        document.getElementById('resumen-envio').textContent = formatearPrecio(envio);
        document.getElementById('resumen-descuento').textContent = `-${formatearPrecio(descuento)}`;
        document.getElementById('resumen-total').textContent = formatearPrecio(total);
      }
      
      // ========================================
      // CONFIRMAR PEDIDO
      // ========================================
      function confirmarPedido() {
        const carritoActual = cargarCarrito();
        
        if (carritoActual.length === 0) {
          mostrarError('El carrito está vacío');
          return;
        }
        
        // Crear pedido simulado
        const nuevoPedido = {
          id: Date.now(),
          fecha: new Date().toISOString().split('T')[0],
          hora: new Date().toLocaleTimeString('es-CL', { hour: '2-digit', minute: '2-digit' }),
          estado: 'confirmado',
          items: carritoActual.map(item => ({
            pizzaId: item.pizzaId,
            nombre: item.nombre,
            tamaño: item.tamaño,
            cantidad: item.cantidad,
            precio: item.precio,
            extras: item.extras || []
          })),
          total: calcularTotalCarrito() + COSTO_ENVIO,
          direccion: usuario.direccion,
          costoEnvio: COSTO_ENVIO,
          eta: '25-30 minutos'
        };
        
        // Guardar pedido en localStorage (simular persistencia)
        let pedidosGuardados = JSON.parse(localStorage.getItem('pedidosLaFornace') || '[]');
        pedidosGuardados.unshift(nuevoPedido);
        localStorage.setItem('pedidosLaFornace', JSON.stringify(pedidosGuardados));
        
        // Limpiar carrito
        vaciarCarrito();
        actualizarBadgeCarrito();
        
        // Redirigir a confirmación
        localStorage.setItem('ultimoPedido', JSON.stringify(nuevoPedido));
        window.location.href = 'confirmacion.html';
      }
      
      // ========================================
      // INICIALIZACIÓN
      // ========================================
      document.addEventListener('DOMContentLoaded', function() {
        // Cargar carrito desde localStorage
        cargarCarrito();
        
        // Renderizar resumen
        renderizarResumen();
        
        // Actualizar badge del carrito
        actualizarBadgeCarrito();
      });
    </script>
</body>
</html>


